# SynthÃ¨se de Session â€” 17 FÃ©vrier 2026

**Objectif de la session** : Terminer la Story 1.3 (Phase 9 â€” Tests et Validation du pipeline GitOps)
**RÃ©sultat** : âœ… Story 1.3 marquÃ©e **Done**

---

## Ce qui a Ã©tÃ© accompli aujourd'hui

### Corrections structurelles (bloquants rÃ©solus)

| # | ProblÃ¨me rencontrÃ© | Fichier(s) modifiÃ©(s) | Solution appliquÃ©e |
|---|--------------------|-----------------------|--------------------|
| 1 | Branche `master` vs `main` â€” workflow ne se dÃ©clenchait pas | `.github/workflows/*.yml` | Renommage `masterâ†’main` + mise Ã  jour triggers |
| 2 | Proxmox node `pve` inexistant (nom rÃ©el : `homelab`) | `deploy-infra.yml`, `create-snapshots.sh`, `rollback.sh` | Correction du nom de node partout |
| 3 | OVH S3 backend : erreur STS AWS au `terraform init` | `terraform/backend.tf` | DÃ©commentage de `skip_requesting_account_id = true` |
| 4 | `terraform apply` dÃ©truisait et recrÃ©ait tous les containers | `terraform/modules/lxc_container/main.tf` | `lifecycle { ignore_changes = [ssh_public_keys, tags] }` |
| 5 | Containers 240/250 dÃ©truits suite au incident Terraform | â€” | `terraform state rm` + `terraform apply` local pour recrÃ©er |
| 6 | SSH key vide sur le runner (CT 210) | â€” | GÃ©nÃ©ration clÃ© + distribution manuelle sur tous les containers |
| 7 | CT 210 (ci-runner) inclus dans le rollback â†’ tue le workflow | `scripts/rollback.sh` | Exclusion de CT 210 de la liste des containers |
| 8 | Container IDs incorrects : 220 inexistant, 201 manquant | `scripts/create-snapshots.sh`, `scripts/rollback.sh` | `CONTAINERS=(200 201 240 250)` pour rollback |
| 9 | Ansible : clÃ© SSH runner absente des containers | `ansible/playbooks/bootstrap-lxc.yml` | Ajout clÃ© `ci-runner-ansible` + correction liste containers |
| 10 | Ansible app-demo bloquÃ© : copie de `node_modules` (50k fichiers) | `ansible/roles/app-demo/tasks/main.yml` | Remplacement `copy` par `synchronize` avec `--exclude=node_modules` |
| 11 | `rsync` absent sur CT 250 + `sudo rsync` inaccessible | `ansible/roles/app-demo/tasks/main.yml`, `ansible/roles/github-runner/tasks/main.yml` | Install rsync sur le remote + `become: false` sur synchronize |
| 12 | Health checks : HTTP 302 considÃ©rÃ© comme FAIL | `scripts/health-check.sh` | Accepter 301/302/502/503 selon le service |
| 13 | CT 210 auto-SSH toujours FAIL | `scripts/health-check.sh` | Exclusion de 192.168.1.210 des checks SSH/Docker |
| 14 | Notification commit : HTTP 403 | `.github/workflows/deploy-infra.yml` | `permissions: contents: write` |
| 15 | Label runner `self-hosted-proxmox` manquant | GitHub Settings â†’ Runners | Ajout du label via UI + restart du service runner |
| 16 | Environment `production` bloquait la branche `main` | GitHub Settings â†’ Environments | Ajout de `main` comme branche autorisÃ©e |

---

## Ã‰tat du pipeline Ã  la clÃ´ture de session

```
Push main â†’ Workflow dÃ©clenchÃ©
  âœ… Snapshots Proxmox (CT 200, 201, 240, 250)
  âœ… Terraform Init + Apply (OVH S3 backend)
  âœ… Ansible Traefik (CT 200)
  âœ… Ansible Utilities (CT 201)
  âœ… Ansible Monitoring (CT 240/202)
  âœ… Ansible App-Demo (CT 250)
  âœ… Health Checks HTTP/SSH/Docker
  âœ… Rollback automatique testÃ© et fonctionnel
  âœ… Notification commit (commentaire GitHub)
```

---

## Modifications futures Ã  planifier

### PrioritÃ© haute â€” StabilitÃ© du pipeline

#### 1. Migrer le CI Runner hors du Proxmox homelab
**ProblÃ¨me** : CT 210 (ci-runner) est gÃ©rÃ© par le mÃªme Terraform qu'il exÃ©cute.
Un `terraform apply` ou `rollback.sh` peut le dÃ©truire et couper le workflow.

**Plan** :
- Provisionner un VPS OVH/Hetzner dÃ©diÃ© au runner
- Configurer WireGuard VPN entre le VPS et le homelab (accÃ¨s SSH aux containers)
- Re-enregistrer le runner GitHub Actions sur le VPS
- Supprimer `module "ci_runner"` de Terraform (gÃ©rÃ© hors-bande)

#### 2. Extraire `module "ci_runner"` en resource directe avec `prevent_destroy`
**ProblÃ¨me** : `lifecycle { prevent_destroy = true }` ne peut pas s'appliquer Ã  un bloc `module`, uniquement Ã  un `resource`.

**Plan** :
```hcl
# Remplacer dans main.tf :
resource "proxmox_lxc" "ci_runner" {
  ...
  lifecycle {
    prevent_destroy = true
    ignore_changes  = all
  }
}
```

#### 3. Ajouter la clÃ© SSH du runner dans le bootstrap Ansible de CT 210
**ProblÃ¨me** : Si CT 210 est recrÃ©Ã©, la clÃ© SSH du runner (`id_ed25519`) sera vide â†’ Ansible Ã©choue.

**Plan** :
- Stocker la clÃ© privÃ©e du runner dans Ansible Vault ou GitHub Secret
- Ajouter une tÃ¢che dans `ansible/roles/github-runner/tasks/main.yml` pour Ã©crire la clÃ© au bootstrap

#### 4. Augmenter le wait post-rollback selon les services
**ProblÃ¨me** : 45s peut ne pas suffire pour que tous les services Docker redÃ©marrent (Grafana, PostgreSQL).

**Plan** :
- ImplÃ©menter un wait-with-retry dans `rollback.sh` (boucle avec `curl` jusqu'Ã  rÃ©ponse)
- Ou augmenter Ã  90s avec un commentaire explicatif

### PrioritÃ© moyenne â€” QualitÃ© et maintenabilitÃ©

#### 5. Corriger l'inventaire Ansible (monitoring affichÃ© sur 192.168.1.250 au lieu de .202)
**ProblÃ¨me** : Les logs Ansible affichaient le mauvais host pour le playbook monitoring.

**Plan** : VÃ©rifier `ansible/inventory.ini` et corriger les groupes `[monitoring]` et `[app_demo]`.

#### 6. Supprimer `node_modules` du dÃ©pÃ´t git
**ProblÃ¨me** : `app-demo/backend/node_modules` et `app-demo/frontend/node_modules` sont commitÃ©s,
alourdissant le repo et causant les problÃ¨mes de `copy` Ansible.

**Plan** :
```bash
echo "app-demo/*/node_modules/" >> .gitignore
git rm -r --cached app-demo/backend/node_modules app-demo/frontend/node_modules
git commit -m "chore: remove node_modules from git tracking"
```

#### 7. ProtÃ©ger la branche `main` via PR obligatoire (sans bypass admin)
**ProblÃ¨me** : Tous les fixes ont Ã©tÃ© pushÃ©s directement sur `main` (bypass admin).
En production rÃ©elle, chaque fix devrait passer par une PR.

**Plan** :
- CrÃ©er des branches `fix/*` pour chaque correction
- Merger via PR aprÃ¨s validation CI
- DÃ©sactiver le bypass admin une fois le pipeline stable

---

## Stories restantes â€” EPIC 1

| Story | Titre | Statut | PrioritÃ© |
|-------|-------|--------|----------|
| **1.1** | GitHub Actions â€” Workflows CI (Terraform Validate, Ansible Lint, Security Scan) | âœ… Done | P0 |
| **1.2** | GitHub Actions â€” Runner Auto-HÃ©bergÃ© Proxmox | âœ… Done | P0 |
| **1.3** | GitHub Actions â€” Pipeline de DÃ©ploiement AutomatisÃ© | âœ… Done | P0 |
| **1.4** | Container Application â€” Infrastructure Terraform | ğŸ”„ In Progress | P1 |
| **1.5** | Container Application â€” Configuration Ansible | ğŸ”„ In Progress | P1 |
| **1.6** | Application de DÃ©monstration â€” DÃ©veloppement Frontend/Backend | ğŸ”„ In Progress | P1 |
| **1.7** | Application de DÃ©monstration â€” IntÃ©gration Traefik | ğŸ”„ In Progress | P1 |
| **1.8** | Application de DÃ©monstration â€” Pipeline CI/CD | ğŸ”„ In Progress | P1 |
| **1.9** | Monitoring AvancÃ© â€” Loki pour AgrÃ©gation de Logs | ğŸ” Ready for Review | P2 |
| **1.10** | Monitoring AvancÃ© â€” Dashboards Grafana VersionnÃ©s | ğŸ“ Todo | P2 |
| **1.11** | Backup et Disaster Recovery Automation | ğŸ“ Todo | P2 |
| **1.12** | SÃ©curitÃ© â€” Scanning et Hardening AutomatisÃ© | ğŸ“ Todo | P2 |
| **1.13** | Documentation Professionnelle â€” Architecture et Runbooks | ğŸ“ Todo | P3 |
| **1.14** | README et Portfolio â€” Transformation en Vitrine Professionnelle | ğŸ“ Todo | P3 |

### Prochaines stories recommandÃ©es (ordre suggÃ©rÃ©)

1. **Story 1.9** (Ready for Review) â†’ Valider et merger Loki
2. **Story 1.4 + 1.5** (In Progress) â†’ Finaliser l'infra et config Ansible du container app-demo
3. **Story 1.6 + 1.7 + 1.8** (In Progress) â†’ App-demo frontend/backend + CI/CD dÃ©diÃ©
4. **Story 1.10** â†’ Dashboards Grafana versionnÃ©s
5. **Story 1.11** â†’ Backup/DR (critique en production)
6. **Story 1.12** â†’ Security hardening
7. **Story 1.13 + 1.14** â†’ Documentation et portfolio (finalisation)

---

## Contexte technique â€” Ã‰tat de l'infra au 17/02/2026

### Containers Proxmox actifs

| VMID | Hostname | IP | RÃ´le | Statut |
|------|----------|----|------|--------|
| 200 | proxy | 192.168.1.200 | Traefik reverse proxy | âœ… Running |
| 201 | utilities | 192.168.1.201 | Vaultwarden, Snipe-IT, NetBox | âœ… Running |
| 210 | ci-runner | 192.168.1.210 | GitHub Actions Runner | âœ… Running |
| 240 | monitoring | 192.168.1.202 | Prometheus, Grafana, Zabbix, Uptime Kuma | âœ… Running |
| 250 | app-demo | 192.168.1.250 | App demo Node.js/React/PostgreSQL | âœ… Running |

### Commits du jour (branche main)
```
a2b0b63  docs(story-1.3): mark story as Done
a124264  fix(workflow): grant contents:write for commit comment notification
cc8ef0a  fix(health-check): add 502/503 for grafana and api startup delays
1b1aa8b  fix(health-check): accept HTTP redirects and remove CI runner self-check
88ded1b  fix(app-demo): install rsync on remote and disable become for synchronize
9da0bf5  fix(runner): add rsync to github-runner system dependencies
067d057  fix(app-demo): use rsync instead of copy to exclude node_modules
f0a045f  fix(scripts): correct container lists in snapshot and rollback scripts
e449d7f  fix(ansible): use existing SSH key on runner instead of overwriting it
b7a5807  fix(bootstrap): update container list and add ci-runner SSH public key
2a0da42  fix(terraform): ignore ssh_public_keys and tags drift on LXC containers
c82e4b2  fix(proxmox): correct node name from 'pve' to 'homelab'
bf679bd  fix(terraform): enable skip_requesting_account_id for OVH S3 backend
537355d  fix(proxmox): correct node name from 'pve' to 'homelab' (workflow+scripts)
44d3b12  fix(ci): update PR workflow triggers from master to main branch
653bdae  Merge pull request #5 (Phase 9 test branch)
```
