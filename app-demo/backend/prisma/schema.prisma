generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int            @id @default(autoincrement())
  email        String         @unique
  passwordHash String         @map("password_hash")
  name         String
  role         Role           @default(viewer)
  createdAt    DateTime       @default(now()) @map("created_at")
  prices       Price[]        @relation("UpdatedBy")
  rules        PricingRule[]  @relation("CreatedBy")
  history      PriceHistory[] @relation("ChangedBy")

  @@map("users")
}

model Channel {
  id          Int            @id @default(autoincrement())
  name        String         @unique
  type        ChannelType
  description String?
  isActive    Boolean        @default(true) @map("is_active")
  createdAt   DateTime       @default(now()) @map("created_at")
  prices      Price[]
  history     PriceHistory[]

  @@map("channels")
}

model Product {
  id             Int            @id @default(autoincrement())
  sku            String         @unique
  name           String
  category       String
  description    String?
  referencePrice Decimal        @map("reference_price") @db.Decimal(10, 2)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  prices         Price[]
  history        PriceHistory[]

  @@map("products")
}

model Price {
  id          Int      @id @default(autoincrement())
  productId   Int      @map("product_id")
  channelId   Int      @map("channel_id")
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("EUR")
  updatedAt   DateTime @updatedAt @map("updated_at")
  updatedById Int?     @map("updated_by")

  product   Product @relation(fields: [productId], references: [id])
  channel   Channel @relation(fields: [channelId], references: [id])
  updatedBy User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@unique([productId, channelId])
  @@map("prices")
}

model PricingRule {
  id          Int       @id @default(autoincrement())
  name        String
  type        RuleType
  value       Decimal   @db.Decimal(10, 2)
  channelIds  Int[]     @map("channel_ids")
  productIds  Int[]     @map("product_ids")
  startsAt    DateTime? @map("starts_at")
  endsAt      DateTime? @map("ends_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdById Int       @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  createdBy User @relation("CreatedBy", fields: [createdById], references: [id])

  @@map("pricing_rules")
}

model PriceHistory {
  id          Int           @id @default(autoincrement())
  productId   Int           @map("product_id")
  channelId   Int           @map("channel_id")
  oldPrice    Decimal       @map("old_price") @db.Decimal(10, 2)
  newPrice    Decimal       @map("new_price") @db.Decimal(10, 2)
  changedById Int           @map("changed_by")
  changedAt   DateTime      @default(now()) @map("changed_at")
  source      HistorySource

  product   Product @relation(fields: [productId], references: [id])
  channel   Channel @relation(fields: [channelId], references: [id])
  changedBy User    @relation("ChangedBy", fields: [changedById], references: [id])

  @@map("price_history")
}

enum Role {
  admin
  manager
  viewer
}

enum ChannelType {
  physical
  ecommerce
  marketplace
}

enum RuleType {
  percentage
  fixed
}

enum HistorySource {
  manual
  rule
  sync
}
