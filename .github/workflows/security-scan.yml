name: Security Scanning

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: self-hosted
    # Security: Only run on PRs from the same repository (not forks) or on direct pushes
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trufflehog

      # â”€â”€â”€ tfsec : Terraform static analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run tfsec on Terraform code
        id: tfsec
        run: |
          echo "Running tfsec security scanner..."
          cd terraform

          # Run tfsec and capture output
          tfsec . --format json --out tfsec-results.json --soft-fail || true
          tfsec . --format default || true

          # Check for CRITICAL or HIGH severity issues
          CRITICAL_COUNT=$(jq '[.results[] | select(.severity == "CRITICAL")] | length' tfsec-results.json)
          HIGH_COUNT=$(jq '[.results[] | select(.severity == "HIGH")] | length' tfsec-results.json)

          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "âŒ Found $CRITICAL_COUNT CRITICAL and $HIGH_COUNT HIGH severity issues"
            exit 1
          else
            echo "âœ… No CRITICAL or HIGH severity issues found"
          fi
        continue-on-error: true

      - name: Upload tfsec results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfsec-results
          path: terraform/tfsec-results.json
          retention-days: 30

      # â”€â”€â”€ Checkov : IaC security scanning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Checkov on Terraform
        id: checkov
        run: |
          echo "Running Checkov IaC scanner..."
          cd terraform

          checkov -d . \
            --framework terraform \
            --output json \
            --output-file-path . \
            --soft-fail || true

          # results_json is checkov's default output name
          RESULTS_FILE="results_json.json"
          if [ -f "$RESULTS_FILE" ]; then
            FAILED=$(jq '.summary.failed // 0' "$RESULTS_FILE")
            PASSED=$(jq '.summary.passed // 0' "$RESULTS_FILE")
            echo "checkov_failed=$FAILED" >> $GITHUB_OUTPUT
            echo "checkov_passed=$PASSED" >> $GITHUB_OUTPUT
            echo "Checkov: $PASSED passed, $FAILED failed"
            [ "$FAILED" -gt 0 ] && exit 1 || true
          else
            echo "checkov_failed=0" >> $GITHUB_OUTPUT
            echo "checkov_passed=0" >> $GITHUB_OUTPUT
            echo "No Checkov results file found"
          fi
        continue-on-error: true

      - name: Upload Checkov results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: terraform/results_json.json
          retention-days: 30

      # â”€â”€â”€ Trivy : Docker image vulnerability scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Trivy on application Docker image
        id: trivy
        run: |
          echo "Running Trivy vulnerability scanner..."

          # Scan the app-demo image (built from app/ directory)
          IMAGE_NAME="infra-oldevops/app-demo:latest"

          # Build image locally for scanning if not cached
          if [ -f "app/Dockerfile" ]; then
            docker build -t "$IMAGE_NAME" app/ -q || docker build -t "$IMAGE_NAME" app/backend/ -q || true
          fi

          # Run Trivy scan â€” fail on CRITICAL (CVSS â‰¥ 9.0)
          trivy image \
            --exit-code 1 \
            --severity CRITICAL \
            --format json \
            --output trivy-results.json \
            "$IMAGE_NAME" 2>/dev/null || TRIVY_EXIT=$?

          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
          echo "trivy_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

          if [ "${TRIVY_EXIT:-0}" -ne 0 ]; then
            echo "âŒ Trivy found $CRITICAL_COUNT CRITICAL vulnerabilities (CVSS â‰¥ 9.0)"
            exit 1
          else
            echo "âœ… No CRITICAL vulnerabilities found by Trivy"
          fi
        continue-on-error: true

      - name: Upload Trivy results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.json
          retention-days: 30

      # â”€â”€â”€ Trufflehog : Secrets detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Scan for secrets with trufflehog
        id: trufflehog
        run: |
          echo "Scanning for secrets with trufflehog..."

          # Scan git history for secrets
          trufflehog git file://. \
            --since-commit HEAD~10 \
            --only-verified \
            --fail \
            --json > trufflehog-results.json || true

          # Check if secrets were found
          SECRET_COUNT=$(jq '. | length' trufflehog-results.json 2>/dev/null || echo "0")
          echo "secret_count=$SECRET_COUNT" >> $GITHUB_OUTPUT

          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "âŒ Found $SECRET_COUNT verified secrets!"
            cat trufflehog-results.json | jq -r '.[] | "âš ï¸ Secret found in: \(.SourceMetadata.Data.Git.file) (commit: \(.SourceMetadata.Data.Git.commit[:8]))"'
            exit 1
          else
            echo "âœ… No verified secrets found"
          fi
        continue-on-error: true

      - name: Upload trufflehog results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-results
          path: trufflehog-results.json
          retention-days: 30

      # â”€â”€â”€ PR Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment PR with Security Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tfsecOutcome    = '${{ steps.tfsec.outcome }}';
            const checkovOutcome  = '${{ steps.checkov.outcome }}';
            const trivyOutcome    = '${{ steps.trivy.outcome }}';
            const trufflehogOutcome = '${{ steps.trufflehog.outcome }}';

            const criticalCount  = '${{ steps.tfsec.outputs.critical_count }}'   || '0';
            const highCount      = '${{ steps.tfsec.outputs.high_count }}'        || '0';
            const checkovFailed  = '${{ steps.checkov.outputs.checkov_failed }}'  || '0';
            const checkovPassed  = '${{ steps.checkov.outputs.checkov_passed }}'  || '0';
            const trivyCritical  = '${{ steps.trivy.outputs.trivy_critical }}'   || '0';
            const secretCount    = '${{ steps.trufflehog.outputs.secret_count }}' || '0';

            const icon = (outcome) => outcome === 'failure' ? 'âŒ' : 'âœ…';

            const output = `### Security Scan Results ğŸ”’

            | Scanner | Status | Details |
            |---------|--------|---------|
            | tfsec (Terraform) | ${icon(tfsecOutcome)} | ${criticalCount} CRITICAL, ${highCount} HIGH |
            | Checkov (IaC) | ${icon(checkovOutcome)} | ${checkovFailed} failed, ${checkovPassed} passed |
            | Trivy (Docker) | ${icon(trivyOutcome)} | ${trivyCritical} CRITICAL vulnerabilities |
            | Trufflehog (Secrets) | ${icon(trufflehogOutcome)} | ${secretCount} verified secrets |

            ğŸ“Š **Artifacts**: tfsec-results Â· checkov-results Â· trivy-results Â· trufflehog-results

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      # â”€â”€â”€ Final gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Final Security Check
        if: |
          steps.tfsec.outcome == 'failure' ||
          steps.checkov.outcome == 'failure' ||
          steps.trivy.outcome == 'failure' ||
          steps.trufflehog.outcome == 'failure'
        run: |
          echo "âŒ Security scan failed - blocking PR merge"
          echo "Please review the security issues and fix them before merging"
          exit 1
