name: Security Scanning

on:
  pull_request:
    branches:
      - master

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: self-hosted
    # Security: Only run on PRs from the same repository (not forks) or on direct pushes
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trufflehog

      - name: Run tfsec on Terraform code
        id: tfsec
        run: |
          echo "Running tfsec security scanner..."
          cd terraform

          # Run tfsec and capture output
          tfsec . --format json --out tfsec-results.json --soft-fail || true
          tfsec . --format default || true

          # Check for CRITICAL or HIGH severity issues
          CRITICAL_COUNT=$(jq '[.results[] | select(.severity == "CRITICAL")] | length' tfsec-results.json)
          HIGH_COUNT=$(jq '[.results[] | select(.severity == "HIGH")] | length' tfsec-results.json)

          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "‚ùå Found $CRITICAL_COUNT CRITICAL and $HIGH_COUNT HIGH severity issues"
            exit 1
          else
            echo "‚úÖ No CRITICAL or HIGH severity issues found"
          fi
        continue-on-error: true

      - name: Upload tfsec results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfsec-results
          path: terraform/tfsec-results.json
          retention-days: 30

      - name: Scan for secrets with trufflehog
        id: trufflehog
        run: |
          echo "Scanning for secrets with trufflehog..."

          # Scan git history for secrets
          trufflehog git file://. \
            --since-commit HEAD~10 \
            --only-verified \
            --fail \
            --json > trufflehog-results.json || true

          # Check if secrets were found
          SECRET_COUNT=$(jq '. | length' trufflehog-results.json 2>/dev/null || echo "0")
          echo "secret_count=$SECRET_COUNT" >> $GITHUB_OUTPUT

          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "‚ùå Found $SECRET_COUNT verified secrets!"
            cat trufflehog-results.json | jq -r '.[] | "‚ö†Ô∏è Secret found in: \(.SourceMetadata.Data.Git.file) (commit: \(.SourceMetadata.Data.Git.commit[:8]))"'
            exit 1
          else
            echo "‚úÖ No verified secrets found"
          fi
        continue-on-error: true

      - name: Upload trufflehog results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-results
          path: trufflehog-results.json
          retention-days: 30

      - name: Comment PR with Security Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tfsecOutcome = '${{ steps.tfsec.outcome }}';
            const trufflehogOutcome = '${{ steps.trufflehog.outcome }}';
            const criticalCount = '${{ steps.tfsec.outputs.critical_count }}' || '0';
            const highCount = '${{ steps.tfsec.outputs.high_count }}' || '0';
            const secretCount = '${{ steps.trufflehog.outputs.secret_count }}' || '0';

            let tfsecStatus = '‚úÖ';
            let tfsecMessage = 'No CRITICAL or HIGH issues found';

            if (tfsecOutcome === 'failure') {
              tfsecStatus = '‚ùå';
              tfsecMessage = `Found ${criticalCount} CRITICAL and ${highCount} HIGH severity issues`;
            }

            let secretsStatus = '‚úÖ';
            let secretsMessage = 'No verified secrets detected';

            if (trufflehogOutcome === 'failure') {
              secretsStatus = '‚ùå';
              secretsMessage = `Found ${secretCount} verified secrets in git history`;
            }

            const output = `### Security Scan Results üîí

            #### Infrastructure Security (tfsec) ${tfsecStatus}
            ${tfsecMessage}

            #### Secrets Detection (trufflehog) ${secretsStatus}
            ${secretsMessage}

            ---

            üìä **Artifacts Available:**
            - tfsec results (JSON)
            - trufflehog results (JSON)

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Final Security Check
        if: steps.tfsec.outcome == 'failure' || steps.trufflehog.outcome == 'failure'
        run: |
          echo "‚ùå Security scan failed - blocking PR merge"
          echo "Please review the security issues and fix them before merging"
          exit 1
