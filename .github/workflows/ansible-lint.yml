name: Ansible Lint

on:
  pull_request:
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible-lint.yml'
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  ansible-lint:
    name: Lint Ansible Configuration
    runs-on: self-hosted

    defaults:
      run:
        working-directory: ansible

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ansible-lint
        id: lint
        run: |
          echo "Running ansible-lint on all playbooks and roles..."
          ansible-lint playbooks/ roles/ || true

          # Store exit code
          LINT_EXIT=$?

          if [ $LINT_EXIT -eq 0 ]; then
            echo "‚úÖ ansible-lint passed with no issues"
          else
            echo "‚ö†Ô∏è ansible-lint found issues (exit code: $LINT_EXIT)"
          fi

          exit $LINT_EXIT
        continue-on-error: true

      - name: Syntax Check - Traefik Playbook
        id: syntax-traefik
        run: ansible-playbook playbooks/traefik.yml --syntax-check
        continue-on-error: true

      - name: Syntax Check - Utilities Playbook
        id: syntax-utilities
        run: ansible-playbook playbooks/utilities.yml --syntax-check
        continue-on-error: true

      - name: Syntax Check - Monitoring Playbook
        id: syntax-monitoring
        run: ansible-playbook playbooks/monitoring.yml --syntax-check
        continue-on-error: true

      - name: Syntax Check - CI Runner Playbook
        id: syntax-ci-runner
        run: ansible-playbook playbooks/ci-runner.yml --syntax-check
        continue-on-error: true

      - name: Syntax Check - Bootstrap Playbook
        id: syntax-bootstrap
        run: ansible-playbook playbooks/bootstrap-lxc.yml --syntax-check
        continue-on-error: true

      - name: Comment PR with Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Ansible Lint üîç\`${{ steps.lint.outcome }}\`

            #### Syntax Checks üìù
            - Traefik: \`${{ steps.syntax-traefik.outcome }}\`
            - Utilities: \`${{ steps.syntax-utilities.outcome }}\`
            - Monitoring: \`${{ steps.syntax-monitoring.outcome }}\`
            - CI Runner: \`${{ steps.syntax-ci-runner.outcome }}\`
            - Bootstrap: \`${{ steps.syntax-bootstrap.outcome }}\`

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Final Status Check
        if: |
          steps.lint.outcome == 'failure' ||
          steps.syntax-traefik.outcome == 'failure' ||
          steps.syntax-utilities.outcome == 'failure' ||
          steps.syntax-monitoring.outcome == 'failure' ||
          steps.syntax-ci-runner.outcome == 'failure' ||
          steps.syntax-bootstrap.outcome == 'failure'
        run: |
          echo "‚ùå Ansible validation failed"
          exit 1
