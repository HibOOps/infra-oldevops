name: Deploy Application

on:
  workflow_run:
    workflows: ["Docker Build and Push"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: deploy-app-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: self-hosted-proxmox
    timeout-minutes: 15
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    environment:
      name: production
      url: https://app.oldevops.fr

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Record start time
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 192.168.1.250 >> ~/.ssh/known_hosts 2>/dev/null
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Pull latest images
        id: pull
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@192.168.1.250 \
            "cd /opt/app-demo && docker compose pull"

      - name: Deploy application
        id: deploy
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@192.168.1.250 \
            "cd /opt/app-demo && docker compose up -d"

      - name: Wait for services to start
        run: sleep 15

      - name: Health check - Frontend
        id: health_frontend
        run: |
          for i in $(seq 1 5); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://app.oldevops.fr || true)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Frontend is healthy (HTTP $HTTP_CODE)"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Attempt $i/5 - Frontend returned HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
          done
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          echo "Frontend health check failed after 5 attempts"
          exit 1
        continue-on-error: true

      - name: Health check - Backend API
        id: health_backend
        run: |
          for i in $(seq 1 5); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://api.oldevops.fr/api/health || true)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Backend API is healthy (HTTP $HTTP_CODE)"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Attempt $i/5 - Backend API returned HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
          done
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          echo "Backend API health check failed after 5 attempts"
          exit 1
        continue-on-error: true

      - name: Rollback on health check failure
        id: rollback
        if: steps.health_frontend.outcome == 'failure' || steps.health_backend.outcome == 'failure'
        run: |
          echo "Health checks failed, initiating rollback..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@192.168.1.250 \
            "cd /opt/app-demo && docker compose down && docker compose up -d"
          echo "Rollback completed - restarted with previous images"

      - name: Fail on unhealthy deployment
        if: steps.health_frontend.outcome == 'failure' || steps.health_backend.outcome == 'failure'
        run: |
          echo "Deployment failed - health checks did not pass"
          echo "Frontend: ${{ steps.health_frontend.outputs.status }}"
          echo "Backend:  ${{ steps.health_backend.outputs.status }}"
          exit 1

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Calculate duration
        id: duration
        if: always()
        run: |
          END=$(date +%s)
          START=${{ steps.timer.outputs.start }}
          ELAPSED=$((END - START))
          MINUTES=$((ELAPSED / 60))
          SECONDS=$((ELAPSED % 60))
          echo "duration=${MINUTES}min ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Post deployment notification
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const timestamp = new Date().toLocaleString('fr-FR', { timeZone: 'Europe/Paris' });
            const jobStatus = '${{ job.status }}';
            const success = jobStatus === 'success';
            const frontendHealth = '${{ steps.health_frontend.outputs.status }}';
            const backendHealth = '${{ steps.health_backend.outputs.status }}';
            const rollbackDone = '${{ steps.rollback.outcome }}' === 'success';
            const duration = '${{ steps.duration.outputs.duration }}';

            let icon, status, footer;
            if (success) {
              icon = 'üöÄ';
              status = 'successful';
              footer = `Deployment completed in ${duration}`;
            } else if (rollbackDone) {
              icon = '‚ö†Ô∏è';
              status = 'failed (rollback performed)';
              footer = `Deployment failed - Rollback performed in ${duration}`;
            } else {
              icon = '‚ùå';
              status = 'failed';
              footer = `Deployment failed in ${duration}`;
            }

            const output = `## ${icon} App Deployment ${status}

            **Date**: ${timestamp}
            **Duration**: ${duration}
            **Commit**: \`${context.sha.substring(0, 7)}\`
            **Actor**: @${{ github.actor }}
            **Workflow**: [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Health Checks
            | Service | Status |
            |---------|--------|
            | Frontend (app.oldevops.fr) | ${frontendHealth === 'healthy' ? '‚úÖ Healthy' : '‚ùå Unhealthy'} |
            | Backend (api.oldevops.fr) | ${backendHealth === 'healthy' ? '‚úÖ Healthy' : '‚ùå Unhealthy'} |
            ${rollbackDone ? '\n### Rollback\n‚ö†Ô∏è Automatic rollback was performed due to failed health checks' : ''}

            ---
            ${footer}
            `;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: output
            });
