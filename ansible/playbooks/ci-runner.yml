---
# Playbook pour configurer le container GitHub Actions Self-Hosted Runner
# Usage: ansible-playbook -i inventory.ini playbooks/ci-runner.yml

- name: Setup GitHub Actions Self-Hosted Runner
  hosts: ci_runner
  become: yes
  gather_facts: yes

  vars_files:
    - ../vault/secrets.yml  # Charge les variables encryptÃ©es

  pre_tasks:
    - name: Validate required variables from vault
      fail:
        msg: "Les variables vault_github_repo_owner et vault_github_runner_token doivent Ãªtre dÃ©finies dans vault/secrets.yml"
      when: vault_github_repo_owner is not defined or vault_github_runner_token is not defined

    - name: Display configuration
      debug:
        msg:
          - "Configuration du runner pour: {{ vault_github_repo_owner }}/{{ vault_github_repo_name }}"
          - "Hostname: {{ ansible_hostname }}"
          - "IP: {{ ansible_default_ipv4.address }}"

  roles:
    - role: common
      tags: ['common', 'docker']

    - role: github-runner
      tags: ['runner']
      vars:
        github_repo_owner: "{{ vault_github_repo_owner }}"
        github_repo_name: "{{ vault_github_repo_name }}"
        github_runner_token: "{{ vault_github_runner_token }}"

  post_tasks:
    - name: Display next steps
      debug:
        msg:
          - "=========================================="
          - "âœ… GitHub Actions Runner installÃ© avec succÃ¨s !"
          - ""
          - "ğŸ“‹ Outils installÃ©s:"
          - "  - Terraform {{ terraform_version }}"
          - "  - Ansible + ansible-lint"
          - "  - tfsec {{ tfsec_version }}"
          - "  - trufflehog"
          - ""
          - "ğŸ” VÃ©rifier le runner sur GitHub:"
          - "  https://github.com/{{ vault_github_repo_owner }}/{{ vault_github_repo_name }}/settings/actions/runners"
          - ""
          - "ğŸš€ Prochaines Ã©tapes:"
          - "  1. CrÃ©er les workflows dans .github/workflows/"
          - "  2. CrÃ©er une PR de test"
          - "  3. VÃ©rifier que le runner exÃ©cute les jobs"
          - "=========================================="
