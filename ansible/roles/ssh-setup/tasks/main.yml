---
# SSH Setup Role - Configure SSH access on LXC containers

- name: Install OpenSSH server
  apt:
    name: openssh-server
    state: present
    update_cache: yes
  tags: ssh

- name: Ensure SSH service is enabled and started
  systemd:
    name: ssh
    enabled: yes
    state: started
  tags: ssh

- name: Create .ssh directory for root
  file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: '0700'
  tags: ssh

- name: Deploy authorized SSH keys for root
  authorized_key:
    user: root
    key: "{{ item }}"
    state: present
  loop: "{{ ssh_public_keys }}"
  when: ssh_public_keys is defined
  tags: ssh

- name: Test SSH key authentication before disabling password auth
  command: ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no root@localhost echo "SSH key works"
  delegate_to: localhost
  changed_when: false
  failed_when: false
  register: ssh_key_test
  tags: ssh

- name: Configure SSH daemon for security (only if keys work or skip security)
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin yes' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication yes' }
    - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
    - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
  notify: restart ssh
  tags: ssh

- name: Warning about password authentication
  debug:
    msg: "WARNING: Password authentication is still enabled. Disable it manually after confirming SSH key access works."
  tags: ssh

- name: Allow SSH through UFW if enabled
  ufw:
    rule: allow
    port: '22'
    proto: tcp
  when: ansible_facts.packages['ufw'] is defined
  ignore_errors: yes
  tags: ssh
