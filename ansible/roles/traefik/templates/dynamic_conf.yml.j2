http:
  middlewares:
    secure-headers:
      headers:
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"
        customResponseHeaders:
          Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'"
          X-Permitted-Cross-Domain-Policies: "none"
          Permissions-Policy: "camera=(), microphone=(), geolocation=()"

    rate-limit:
      rateLimit:
        average: 1000
        burst: 500

    uptime-kuma-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        # Allow WebSocket connections (socket.io used by Uptime Kuma)
        contentSecurityPolicy: "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: wss: ws:; img-src 'self' data: https:;"

  routers:
    pricesync-api:
      rule: "Host(`demo.{{ domain_name }}`) && PathPrefix(`/api`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: pricesync-api
      priority: 20
      middlewares:
        - secure-headers
        - rate-limit
    pricesync-frontend:
      rule: "Host(`demo.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: pricesync-frontend
      priority: 10
      middlewares:
        - secure-headers
        - rate-limit
    vaultwarden:
      rule: "Host(`vault.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: vaultwarden
      middlewares:
        - secure-headers
        - rate-limit
    snipeit:
      rule: "Host(`inventory.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: snipeit
      middlewares:
        - secure-headers
        - rate-limit
    uptimekuma:
      rule: "Host(`status.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: uptimekuma
      middlewares:
        - uptime-kuma-headers
        - rate-limit
    alertmanager:
      rule: "Host(`alertmanager.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: alertmanager
      middlewares:
        - secure-headers
        - rate-limit
    prometheus:
      rule: "Host(`prometheus.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: prometheus
      middlewares:
        - secure-headers
        - rate-limit
    grafana:
      rule: "Host(`grafana.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: grafana
      middlewares:
        - secure-headers
        - rate-limit
    netbox:
      rule: "Host(`netbox.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: netbox
      middlewares:
        - secure-headers
        - rate-limit
    dashboard:
      rule: "Host(`proxy.{{ domain_name }}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: ovh
      service: api@internal
      middlewares:
        - secure-headers

  services:
    vaultwarden:
      loadBalancer:
        servers:
          - url: "http://192.168.1.201:8082"
    snipeit:
      loadBalancer:
        servers:
          - url: "http://192.168.1.201:8081"
    uptimekuma:
      loadBalancer:
        servers:
          - url: "http://192.168.1.202:3001"
    alertmanager:
      loadBalancer:
        servers:
          - url: "http://192.168.1.202:9093"
    prometheus:
      loadBalancer:
        servers:
          - url: "http://192.168.1.202:9090"
    grafana:
      loadBalancer:
        servers:
          - url: "http://192.168.1.202:3000"
    netbox:
      loadBalancer:
        servers:
          - url: "http://192.168.1.201:8084"
    pricesync-frontend:
      loadBalancer:
        servers:
          - url: "http://192.168.1.250:80"
        healthCheck:
          path: /
          interval: 15s
          timeout: 5s
    pricesync-api:
      loadBalancer:
        servers:
          - url: "http://192.168.1.250:5000"
        healthCheck:
          path: /api/health
          interval: 15s
          timeout: 5s

tls:
  options:
    tls-min13:
      minVersion: VersionTLS13
    default:
      minVersion: VersionTLS12
      cipherSuites:
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
