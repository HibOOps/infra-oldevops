---
- name: Install rsync (required for synchronize module)
  apt:
    name: rsync
    state: present
    update_cache: false

- name: Create app-demo directory
  file:
    path: "{{ app_demo_dir }}"
    state: directory
    mode: '0755'

- name: Sync app-demo backend source (excluding node_modules)
  synchronize:
    src: "{{ playbook_dir }}/../../app-demo/backend/"
    dest: "{{ app_demo_dir }}/backend/"
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.git"

- name: Sync app-demo frontend source (excluding node_modules)
  synchronize:
    src: "{{ playbook_dir }}/../../app-demo/frontend/"
    dest: "{{ app_demo_dir }}/frontend/"
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.git"

- name: Copy app-demo docker-compose.yml
  copy:
    src: "{{ playbook_dir }}/../../app-demo/docker-compose.yml"
    dest: "{{ app_demo_dir }}/docker-compose.yml"

- name: Copy app-demo .env.example as reference
  copy:
    src: "{{ playbook_dir }}/../../app-demo/.env.example"
    dest: "{{ app_demo_dir }}/.env.example"
  ignore_errors: yes

- name: Deploy .env file
  template:
    src: env.j2
    dest: "{{ app_demo_dir }}/.env"
    mode: '0600'

- name: Create Docker volumes directories
  file:
    path: "{{ app_demo_dir }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - data/postgres

- name: Build and start app-demo stack
  community.docker.docker_compose_v2:
    project_src: "{{ app_demo_dir }}"
    build: always
    state: present
  register: app_demo_deploy

- name: Wait for services to be healthy
  wait_for:
    host: "{{ ansible_default_ipv4.address }}"
    port: "{{ item }}"
    delay: 5
    timeout: 60
  loop:
    - "{{ app_demo_backend_port }}"
    - "{{ app_demo_frontend_port }}"
