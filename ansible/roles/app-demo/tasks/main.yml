---

- name: Install rsync on remote host (required for synchronize module)
  apt:
    name: rsync
    state: present

- name: Create app-demo directory
  file:
    path: "{{ app_demo_dir }}"
    state: directory
    mode: '0755'

- name: Sync app-demo backend source (excluding node_modules)
  synchronize:
    src: "{{ playbook_dir }}/../../app-demo/backend/"
    dest: "{{ app_demo_dir }}/backend/"
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.git"
  become: false

- name: Sync app-demo frontend source (excluding node_modules)
  synchronize:
    src: "{{ playbook_dir }}/../../app-demo/frontend/"
    dest: "{{ app_demo_dir }}/frontend/"
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.git"
  become: false

- name: Copy app-demo docker-compose.yml
  copy:
    src: "{{ playbook_dir }}/../../app-demo/docker-compose.yml"
    dest: "{{ app_demo_dir }}/docker-compose.yml"

- name: Copy app-demo .env.example as reference
  copy:
    src: "{{ playbook_dir }}/../../app-demo/.env.example"
    dest: "{{ app_demo_dir }}/.env.example"
  ignore_errors: yes

- name: Deploy .env file
  template:
    src: env.j2
    dest: "{{ app_demo_dir }}/.env"
    mode: '0600'

- name: Build and start PriceSync stack
  community.docker.docker_compose_v2:
    project_src: "{{ app_demo_dir }}"
    build: always
    state: present
  register: app_demo_deploy

- name: Wait for pricesync-backend to be healthy
  command: >
    docker inspect --format="{{ '{{' }}.State.Health.Status{{ '}}' }}" pricesync-backend
  register: backend_health
  until: backend_health.stdout == "healthy"
  retries: 20
  delay: 10

- name: Wait for pricesync-frontend to be healthy
  command: >
    docker inspect --format="{{ '{{' }}.State.Health.Status{{ '}}' }}" pricesync-frontend
  register: frontend_health
  until: frontend_health.stdout == "healthy"
  retries: 12
  delay: 10
